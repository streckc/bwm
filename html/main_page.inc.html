<div id="visualization"></div>
<div id="graph_config">
  <input type="text" name="start" id="start" value="__TODAY__" />
 to 
  <input type="text" name="start" id="start" value="__TOMORROW__" />
<!-- by 
  <select name="resolution" id="resolution">
    <option value="1m" selected="selected">1 minute</option>
    <option value="15m">15 minute</option>
    <option value="1h">1 hour</option>
    <option value="1d">1 day</option>
  </select>
</div> -->
<div id="graph_select">
  <select name="graph_1" id="graph_1"><option value="-1" selected="selected">All hosts</option></select><br />
  <select name="graph_2" id="graph_2"><option value="0">None</option></select><br />
  <select name="graph_3" id="graph_3"><option value="0">None</option></select><br />
  <select name="graph_4" id="graph_4"><option value="0">None</option></select><br />
  <select name="graph_5" id="graph_5"><option value="0">None</option></select>
</div>
<script type="text/javascript">
  function update_graph_data(gid) {
    host_id = $( '#graph_'+gid+' option:selected' ).attr('value');
    text = $( '#graph_'+gid+' option:selected' ).text().split(':')[0];
    params = {
              host_id: host_id,
              start_date: $( '#start' ).attr('value'),
              end_date: $( '#end' ).attr('value')
             }
    if (groups.get(gid)) {
      if (text == 'None') {
        group = groups.remove(gid);
      } else {
        group = groups.update({ 'id': gid, 'content': text });
      }
    } else if (host_id >= 0) {
      groups.add({id: gid, content: text, options: {drawPoints: false, shaded: {orientation: 'bottom'}}});
    }
    var new_data = dataset.get({
      filter: function (item) {
        return (item.group != gid);
      }
    });
    $.ajax({
      type: 'post',
      url: '/bw',
      data: params,
      success: function( data ) {
        var bandwidth = []
        for (obj in data) {
          new_data.push({x: data[obj].date,
                        y: (data[obj].length/1024/1024*8/60),
                        group: gid});
        }

        dataset.clear();
        dataset.add(new_data);
      }
    });
  }


  function set_graph_selections() {
    $.ajax({
      type: 'get',
      url: '/hosts',
      success: function( data ) {
        data.sort(function(a, b) {
          aa = a.addr.split('.');
          bb = b.addr.split('.');
          return ( aa[0]*0x1000000 + aa[1]*0x10000 + aa[2]*0x100 + aa[3]*1 )
               - ( bb[0]*0x1000000 + bb[1]*0x10000 + bb[2]*0x100 + bb[3]*1 );
        });
        for (obj in data) {
          for (i=1; i<=5; i++) {
          $('#graph_'+i)
              .append($('<option></option>')
              .attr('value',data[obj].host_id)
              .text(data[obj].addr+': '+data[obj].name.split('.')[0])); 
          }
        }
      }
    });
  }


  var container = document.getElementById('visualization');
  var dataset = new vis.DataSet();
  var groups = new vis.DataSet();
  groups.add({id: 1, content: 'All hosts', options: {drawPoints: false, shaded: {orientation: 'bottom'}}});
  var options = { start: '__TODAY__', end: '__TOMORROW__', legend: {left: {position: 'top-left'}} };
  options['dataAxis'] = { left: {range: {min: 0}, title: {text: 'Mbps'}}};
  var graph2d = new vis.Graph2d(container, dataset, groups, options);

  set_graph_selections();
  update_graph_data(1);
  $( "#graph_1" ).change(function() { update_graph_data(1); });
  $( "#graph_2" ).change(function() { update_graph_data(2); });
  $( "#graph_3" ).change(function() { update_graph_data(3); });
  $( "#graph_4" ).change(function() { update_graph_data(4); });
  $( "#graph_5" ).change(function() { update_graph_data(5); });
</script>
